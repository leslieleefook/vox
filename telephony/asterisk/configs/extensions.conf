; Asterisk Dialplan for Vox
; Handles incoming calls and routes to LiveKit

[general]
static = yes
writeprotect = no
clearglobalvars = no

[globals]
; Global variables for AGI server
AGI_HOST = control-plane
AGI_PORT = 4573

; ============== External Incoming Calls ==============
; PSTN calls arrive here from SIP trunk

[from-external]
; Log incoming call
exten => _+X.,1,NoOp(=== Incoming PSTN call from ${CALLERID(num)} to ${EXTEN} ===)
same => n,Set(CHANNEL(language)=en)

; Query the FastAPI AGI server for the Assistant ID
; AGI sets VOX_ASSISTANT_ID variable
same => n,AGI(agi://${AGI_HOST}:${AGI_PORT}/route)

; Check if we got a valid assistant
same => n,GotoIf($["${VOX_ASSISTANT_ID}" = ""]?no_assistant)

; Route to LiveKit SIP Gateway with the Assistant ID header
; Using PJSIP_HEADER to pass metadata to LiveKit
same => n,Dial(PJSIP/${EXTEN}@livekit-bridge,120,b(add-headers^s^1))

; Handle dial result
same => n,Goto(dial-${DIALSTATUS},1)

[dial-ANSWER]
exten => s,1,NoOp(Call answered)
same => n,Hangup()

[dial-NOANSWER]
exten => s,1,NoOp(No answer)
same => n,Hangup()

[dial-BUSY]
exten => s,1,NoOp(Busy)
same => n,Busy()

[dial-CONGESTION]
exten => s,1,NoOp(Congestion)
same => n,Congestion()

[dial-CHANUNAVAIL]
exten => s,1,NoOp(Channel unavailable)
same => n,Playback(vm-sorry)
same => n,Hangup()

[from-external]
; No assistant found for this number
exten => _+X.,n(no_assistant),NoOp(No assistant configured for ${EXTEN})
same => n,Playback(vm-sorry)
same => n,Hangup()

; ============== Header Addition ==============
; Add custom headers before dialing LiveKit

[add-headers]
exten => s,1,NoOp(Adding Vox headers)
same => n,Set(PJSIP_HEADER(add,X-Vox-Assistant-ID)=${VOX_ASSISTANT_ID})
same => n,Set(PJSIP_HEADER(add,X-Vox-Caller-ID)=${CALLERID(num)})
same => n,Set(PJSIP_HEADER(add,X-Vox-Call-ID)=${CHANNEL(linkedid)})
same => n,Return()

; ============== LiveKit Incoming ==============
; Calls coming back from LiveKit (for potential future use)

[from-livekit]
exten => _X.,1,NoOp(Call from LiveKit: ${EXTEN})
same => n,Hangup()

; ============== Test Extension ==============
; For testing AGI connectivity

[test-agi]
exten => 100,1,NoOp(Testing AGI connection)
same => n,AGI(agi://${AGI_HOST}:${AGI_PORT}/route)
same => n,NoOp(Assistant ID: ${VOX_ASSISTANT_ID})
same => n,Playback(vm-sorry)
same => n,Hangup()
